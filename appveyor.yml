image: Visual Studio 2017
shallow_clone: true
test: off
skip_branch_with_pr: true
skip_tags: true
configuration: Release

#branches:
#  only:
#  - master

only_commits:
  files:
  - appveyor.yml
  - src\*
  - nuspecs\*

nuget:
  disable_publish_on_pr: true

init:
- ps: >-
    $parsedBuildVersion = $env:APPVEYOR_REPO_TAG_NAME -Match "(\d+.\d+.\d+(.\d+)?)"
    
    If($env:appveyor_repo_tag -AND $parsedBuildVersion) {
      $env:BuildVersion = $matches[0]
      $env:HasTag = $TRUE
    }
    else {
      $env:BuildVersion = $env:appveyor_build_version
      $env:HasTag = ""
    }
    
    Write-Host "Build Version: " $env:BuildVersion
    Write-Host "Tag name:  " $env:appveyor_repo_tag
    Write-Host "Commit: " $env:APPVEYOR_REPO_COMMIT_MESSAGE 
    Write-Host "Commit extended:" $env:APPVEYOR_REPO_COMMIT_MESSAGE_EXTENDED
    
    Write-Host "appveyor_build_version Variable: " $env:appveyor_build_version
  
assembly_info:
  patch: true
  file: 'src\**\AssemblyInfo.cs'
  assembly_version: $(BuildVersion)
  assembly_file_version: $(BuildVersion)
  assembly_informational_version: "$(BuildVersion)-build$(env:APPVEYOR_BUILD_NUMBER)"

before_build:
  - nuget restore PrismLibrary.sln
  - dotnet restore PrismLibrary.sln  

build:
  parallel: true
  project: PrismLibrary.sln
  verbosity: minimal

test_script:
  - dotnet test test\Prism.Tests\Prism.Tests.csproj
  - vstest.console /logger:Appveyor test\Prism.Wpf.Tests\bin\Release\Prism.Wpf.Tests.dll
  - vstest.console /logger:Appveyor test\Prism.Autofac.Wpf.Tests\bin\Release\Prism.Autofac.Wpf.Tests.dll
  - vstest.console /logger:Appveyor test\Prism.DryIoc.Wpf.Tests\bin\Release\Prism.DryIoc.Wpf.Tests.dll
  - vstest.console /logger:Appveyor test\Prism.Mef.Wpf.Tests\bin\Release\Prism.Mef.Wpf.Tests.dll
  - vstest.console /logger:Appveyor test\Prism.StructureMap.Wpf.Tests\bin\Release\Prism.StructureMap.Wpf.Tests.dll
  - vstest.console /logger:Appveyor test\Prism.Unity.Wpf.Tests\bin\Release\Prism.Unity.Wpf.Tests.dll
  # Xamarin tests are currently disabled due to a blocking issue: https://bugzilla.xamarin.com/show_bug.cgi?id=53060
  # UWP tests are not currently not supported by appveyor: https://github.com/appveyor/ci/issues/393

after_test:
  - dotnet pack src\Prism\ -c Release --version-suffix "build$(env:APPVEYOR_BUILD_NUMBER)"
  # Xamarin packaging is currently disabled due to a blocking issue: https://bugzilla.xamarin.com/show_bug.cgi?id=53060
  - ps: .\nuget.ps1

artifacts:
  path: 'src\**\*.nupkg'
  name: Nuget

deploy:  
- provider: NuGet
  server: https://www.myget.org/F/prism-pre/api/v2/package
  api_key:
    secure: ZR2WeSlQqSkfL6YpxWzIqhdeKSdxxPqp9yvN7l+SyIX+yIHNcKNqCENWcE8A6GsQ
  skip_symbols: true
  on:
    branch: master
    HasTag: true